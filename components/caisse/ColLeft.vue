<script setup lang="ts">
import { ref, computed } from 'vue'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import {
    Combobox, ComboboxAnchor, ComboboxInput, ComboboxList, ComboboxItem, ComboboxEmpty, ComboboxGroup
} from '@/components/ui/combobox'
import {
    Dialog,
    DialogTrigger,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { UserRoundPlus, X, User, List } from 'lucide-vue-next'
import { Input } from '@/components/ui/input'
import { ContextMenu, ContextMenuContent, ContextMenuItem, ContextMenuSeparator, ContextMenuTrigger } from '@/components/ui/context-menu'
import type { ClientBase } from '@/types'

import { useCartStore } from '@/stores/cart'
const cartStore = useCartStore()

const selectedClient = ref<ClientBase | null>(null)
const props = defineProps(['clients'])
const Clients = computed(() => props.clients)

const pendingTickets = 3

function deselectClient() {
    selectedClient.value = null
}

function openClientCard() {
    console.log('Fiche client')
}

function openClientHistory() {
    console.log('Historique client')
} 
</script>


<template>
    <div class="max-w-xs mx-auto space-y-4">
        <!-- S√©lecteur vendeur -->
        <div>
            <label class="text-sm font-semibold">Vendeur</label>
            <Select defaultValue="">
                <SelectTrigger>
                    <SelectValue placeholder="S√©lectionner un vendeur" />
                </SelectTrigger>
                <SelectContent>
                    <SelectItem value="yohan">Yohan</SelectItem>
                    <SelectItem value="mary">Mary</SelectItem>
                    <SelectItem value="jade">Jade</SelectItem>
                </SelectContent>
            </Select>
        </div>

        <!-- Client -->
        <div>
            <label class="text-sm font-semibold">Client</label>
            <div class="flex items-center gap-2 mt-2">
                <!-- üîç Recherche -->
                <Combobox v-model="selectedClient" :options="Clients" :option-value="(c: ClientBase) => c.id"
                    :option-label="(c: ClientBase) => c.name" :get-option-value="(c: ClientBase) => c.id"
                    :get-option-label="(c: ClientBase) => c.name">
                    <ComboboxAnchor>
                        <div class="relative w-full flex items-center rounded-md border">
                            <ComboboxInput placeholder="Rechercher un client" class="w-full h-full px-3 text-sm" />
                        </div>
                    </ComboboxAnchor>
                    <ComboboxList>
                        <ComboboxEmpty>Aucun r√©sultat</ComboboxEmpty>
                        <ComboboxGroup>
                            <ComboboxItem v-for="item in Clients" :key="item.id" :value="item">
                                <div class="flex flex-col leading-tight">
                                    <div class="font-semibold text-sm">{{ item.name }} {{ item.lastname }}</div>
                                    <div class="text-xs text-gray-500">{{ item.city }}</div>
                                </div>
                            </ComboboxItem>
                        </ComboboxGroup>
                    </ComboboxList>
                </Combobox>

                <!-- ‚ûï Bouton -->
                <Dialog>
                    <DialogTrigger class="flex items-center">
                        <Button variant="outline">
                            <UserRoundPlus class="w-5 h-5" />
                        </Button>
                    </DialogTrigger>
                    <CaisseAddClientForm />
                </Dialog>
            </div>

            <!-- Card client, toujours pr√©sente -->
            <div class="relative mt-2 px-4 py-3 rounded-md shadow-sm"
                :class="selectedClient ? 'bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 border' : 'bg-transparent'"
                style="min-height: 66px;">
                <template v-if="selectedClient">
                    <!-- ‚ùå Bouton de suppression -->
                    <button @click="deselectClient" class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
                        <X class="w-4 h-4" />
                    </button>

                    <!-- üßç Infos client -->
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold text-base">
                                {{ selectedClient.name }} {{ selectedClient.lastname }}
                            </div>
                            <div class="text-xs text-gray-500">
                                {{ selectedClient.city }}
                            </div>
                        </div>

                        <!-- üîò Actions -->
                        <div class="flex items-center gap-2 pr-5">
                            <button @click="openClientCard"
                                class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                                <User class="w-5 h-5 text-gray-600 dark:text-gray-300" />
                            </button>
                            <button @click="openClientHistory"
                                class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800">
                                <List class="w-5 h-5 text-gray-600 dark:text-gray-300" />
                            </button>
                        </div>
                    </div>
                </template>
            </div>

        </div>

        <!-- Remise globale -->
        <div>
            <label class="text-sm font-semibold">Remise globale</label>
            <div class="flex gap-2 mt-2">
                <Input type="number" min="0" placeholder="0" class="w-full" v-model.number="cartStore.globalDiscount" />
                <Select v-model="cartStore.globalDiscountType">
                    <SelectTrigger class="w-20">
                        <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="%">%</SelectItem>
                        <SelectItem value="‚Ç¨">‚Ç¨</SelectItem>
                    </SelectContent>
                </Select>
            </div>
        </div>

        <!-- Mise en attente / Reprise -->
        <div class="flex gap-2">
            <Button variant="outline" class="flex-1">Mise en attente</Button>
            <Dialog class="flex-1">
                <DialogTrigger>
                    <Button variant="secondary">
                        Reprise
                        <Badge class="ml-2 bg-red-500" variant="default">{{ pendingTickets }}</Badge>
                    </Button>
                </DialogTrigger>
                <CaissePendingTicketForm />
            </Dialog>
        </div>

        <!-- Grille de raccourcis -->
        <div>
            <label class="text-sm font-semibold mb-2 block">Raccourcis</label>
            <div class="grid grid-cols-3 gap-2">
                <ContextMenu v-for="n in 24" :key="n">
                    <ContextMenuTrigger>
                        <Button class="h-12 rounded text-sm w-full" variant="secondary">
                            Vide
                        </Button>
                    </ContextMenuTrigger>
                    <ContextMenuContent>
                        <ContextMenuItem>Cr√©er un raccourci produit</ContextMenuItem>
                        <ContextMenuItem>Cr√©er un raccourci client</ContextMenuItem>
                        <ContextMenuSeparator />
                        <ContextMenuItem>Autre action</ContextMenuItem>
                    </ContextMenuContent>
                </ContextMenu>
            </div>
        </div>
    </div>
</template>